// Test script to simulate user creating AI recipe from Flutter mobile app
// This demonstrates the sync process from mobile app to admin panel

require('dotenv').config();
require('./config/conn');
const savedAiRecipeModel = require('./model/savedAiRecipeModel');
const userModel = require('./model/userModel');
const mongoose = require('mongoose');

async function testMobileUserCreateAIRecipe() {
    try {
        console.log('ğŸ“± Testing: Mobile User Creates New AI Recipe');
        console.log('=' .repeat(50));

        // Get a real user from database (simulate logged in mobile user)
        const user = await userModel.findOne({ email: 'huyplumber@gmail.com' });
        if (!user) {
            console.error('âŒ User not found. Please make sure user exists in database.');
            process.exit(1);
        }

        console.log(`ğŸ‘¤ Logged in user: ${user.firstname} ${user.lastname} (${user.email})`);

        // Simulate AI recipe generated by user on mobile
        const newAIRecipe = {
            id: `mobile_ai_recipe_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
            title: 'CÆ¡m ChiÃªn Háº£i Sáº£n Cay',
            description: 'MÃ³n cÆ¡m chiÃªn Ä‘áº­m Ä‘Ã  hÆ°Æ¡ng vá»‹ vá»›i tÃ´m, má»±c vÃ  gia vá»‹ cay ná»“ng. ÄÆ°á»£c táº¡o bá»Ÿi AI dá»±a trÃªn sá»Ÿ thÃ­ch áº©m thá»±c Viá»‡t Nam.',
            ingredients: [
                '300g cÆ¡m nguá»™i',
                '150g tÃ´m sÃº, bÃ³c vá»',
                '100g má»±c á»‘ng, thÃ¡i khoanh',
                '2 quáº£ trá»©ng gÃ ',
                '3 tÃ©p tá»i bÄƒm nhá»',
                '1 cá»§ hÃ nh tÃ¢y thÃ¡i nhá»',
                '2 muá»—ng canh dáº§u Äƒn',
                '1 muá»—ng canh tÆ°Æ¡ng á»›t',
                '1 muá»—ng cÃ  phÃª Ä‘Æ°á»ng',
                'Rau mÃ¹i, hÃ nh lÃ¡ Ä‘á»ƒ trang trÃ­',
                'TiÃªu, muá»‘i vá»«a Äƒn'
            ],
            instructions: [
                'LÃ m nÃ³ng wok vá»›i dáº§u Äƒn trÃªn lá»­a lá»›n',
                'Phi thÆ¡m tá»i vÃ  hÃ nh tÃ¢y trong 1 phÃºt',
                'Cho tÃ´m vÃ  má»±c vÃ o xÃ o Ä‘áº¿n khi chÃ­n tÃ¡i',
                'Äáº­p trá»©ng vÃ o cháº£o, khuáº¥y Ä‘á»u',
                'ThÃªm cÆ¡m nguá»™i, dÃ¹ng Ä‘Å©a tÃ¡ch Ä‘á»u cÃ¡c háº¡t cÆ¡m',
                'NÃªm tÆ°Æ¡ng á»›t, Ä‘Æ°á»ng, muá»‘i vÃ  tiÃªu',
                'XÃ o Ä‘á»u trong 3-4 phÃºt cho Ä‘áº¿n khi cÆ¡m nÃ³ng Ä‘á»u',
                'Táº¯t báº¿p, ráº¯c rau mÃ¹i vÃ  hÃ nh lÃ¡'
            ],
            cuisine: 'Vietnamese',
            preparationTime: 15,
            cookingTime: 12,
            servings: 3,
            difficulty: 'Medium',
            tags: ['vietnamese', 'fried-rice', 'seafood', 'spicy', 'quick-meal', 'ai-generated'],
            imageUrl: 'https://via.placeholder.com/400x300?text=Seafood+Fried+Rice',
            estimatedCalories: 320,
            recipeCreatedAt: new Date(),
            userId: user._id,
            userEmail: user.email,
            deviceInfo: {
                platform: 'flutter',
                os: 'Android',
                version: '13',
                device: 'Samsung Galaxy S23'
            },
            status: 'active'
        };

        console.log(`ğŸ³ Creating new AI recipe: "${newAIRecipe.title}"`);
        console.log(`ğŸ“Š Details: ${newAIRecipe.servings} servings, ${newAIRecipe.preparationTime + newAIRecipe.cookingTime} mins, ${newAIRecipe.difficulty} difficulty`);

        // Step 1: Save to database (simulating mobile app sync)
        const savedRecipe = new savedAiRecipeModel(newAIRecipe);
        await savedRecipe.save();

        console.log('âœ… Recipe saved to database successfully!');
        console.log(`ğŸ“ Recipe ID: ${savedRecipe._id}`);

        // Step 2: Verify in admin panel query
        const allRecipes = await savedAiRecipeModel.find({ status: 'active' })
            .populate('userId', 'firstname lastname email')
            .sort({ createdAt: -1 })
            .limit(5);

        console.log('\nğŸ” Recent AI Recipes in Admin Panel:');
        console.log('=' .repeat(50));
        
        allRecipes.forEach((recipe, index) => {
            console.log(`${index + 1}. ${recipe.title}`);
            console.log(`   ğŸ‘¤ User: ${recipe.userId?.firstname} ${recipe.userId?.lastname} (${recipe.userId?.email})`);
            console.log(`   ğŸ½ï¸  Cuisine: ${recipe.cuisine} | ğŸ‘¥ Servings: ${recipe.servings} | â±ï¸  Time: ${recipe.preparationTime + recipe.cookingTime} mins`);
            console.log(`   ğŸ“… Created: ${recipe.createdAt?.toLocaleString()}`);
            console.log('');
        });

        console.log('ğŸ‰ SUCCESS: New mobile AI recipe appears in admin panel!');
        console.log('ğŸŒ Admin Panel URL: http://localhost:3000/saved-ai-recipes');
        console.log('');
        console.log('ğŸ”„ Real App Flow:');
        console.log('   1. User generates AI recipe on Flutter mobile app');
        console.log('   2. Recipe saves to local SharedPreferences');
        console.log('   3. App calls sync API to send recipe to backend');
        console.log('   4. Backend saves to MongoDB savedairecipes collection');
        console.log('   5. Admin panel displays recipe in real-time');

    } catch (error) {
        console.error('âŒ Error testing mobile AI recipe creation:', error.message);
        process.exit(1);
    } finally {
        process.exit(0);
    }
}

testMobileUserCreateAIRecipe();