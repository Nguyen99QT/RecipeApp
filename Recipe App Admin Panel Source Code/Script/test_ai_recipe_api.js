const axios = require('axios');

// Base URL for the API
const baseURL = 'http://localhost:3000'; // Change this to your server URL

// Test data
const testData = {
    // You need to get a valid token from login first
    authToken: 'your_auth_token_here',
    sampleRecipe: {
        recipeName: 'AI Generated Pasta',
        recipeContent: 'Delicious pasta recipe generated by AI...',
        ingredients: ['pasta', 'tomato sauce', 'cheese', 'herbs'],
        cookingTime: 30,
        servingSize: 4,
        difficultyLevel: 'Easy',
        tags: ['italian', 'pasta', 'quick']
    }
};

// Helper function to make authenticated requests
async function makeRequest(endpoint, method = 'POST', data = {}) {
    try {
        const config = {
            method,
            url: `${baseURL}${endpoint}`,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${testData.authToken}`
            },
            data
        };

        const response = await axios(config);
        console.log(`âœ… ${method} ${endpoint}:`, response.data);
        return response.data;
    } catch (error) {
        console.error(`âŒ ${method} ${endpoint}:`, error.response?.data || error.message);
        return null;
    }
}

// Test functions
async function testSaveAiRecipe() {
    console.log('\nğŸ§ª Testing Save AI Recipe...');
    const result = await makeRequest('/saveAiRecipe', 'POST', testData.sampleRecipe);
    if (result && result.success) {
        testData.savedRecipeId = result.data._id;
        console.log('ğŸ’¾ Recipe saved with ID:', testData.savedRecipeId);
    }
    return result;
}

async function testGetUserAiRecipes() {
    console.log('\nğŸ§ª Testing Get User AI Recipes...');
    const result = await makeRequest('/getUserAiRecipes', 'POST', {});
    if (result && result.success) {
        console.log('ğŸ“„ Found', result.data.length, 'AI recipes');
    }
    return result;
}

async function testUpdateAiRecipe() {
    console.log('\nğŸ§ª Testing Update AI Recipe...');
    if (!testData.savedRecipeId) {
        console.log('âš ï¸ No saved recipe ID found. Skipping update test.');
        return null;
    }

    const updateData = {
        recipeId: testData.savedRecipeId,
        recipeName: 'Updated AI Generated Pasta',
        cookingTime: 25,
        tags: ['italian', 'pasta', 'quick', 'updated']
    };

    const result = await makeRequest('/updateAiRecipe', 'POST', updateData);
    return result;
}

async function testDeleteAiRecipe() {
    console.log('\nğŸ§ª Testing Delete AI Recipe...');
    if (!testData.savedRecipeId) {
        console.log('âš ï¸ No saved recipe ID found. Skipping delete test.');
        return null;
    }

    const result = await makeRequest('/deleteAiRecipe', 'POST', {
        recipeId: testData.savedRecipeId
    });
    return result;
}

// Test authentication endpoints (you need to run this first to get a token)
async function testLogin() {
    console.log('\nğŸ§ª Testing Login (to get auth token)...');
    console.log('â„¹ï¸ Please update the credentials below with valid user data:');
    
    const loginData = {
        email: 'test@example.com', // Update this
        password: 'password123'     // Update this
    };

    try {
        const response = await axios.post(`${baseURL}/SignIn`, loginData);
        if (response.data.success && response.data.token) {
            testData.authToken = response.data.token;
            console.log('âœ… Login successful! Token saved.');
            return response.data;
        } else {
            console.log('âŒ Login failed:', response.data.message);
        }
    } catch (error) {
        console.error('âŒ Login error:', error.response?.data || error.message);
    }
    return null;
}

// Main test runner
async function runAllTests() {
    console.log('ğŸš€ Starting AI Recipe API Tests...');
    console.log('ğŸ“ Base URL:', baseURL);
    
    // First, you need to login to get an auth token
    console.log('\nâš ï¸ IMPORTANT: Update the login credentials in testLogin() function');
    console.log('âš ï¸ Then uncomment the testLogin() call below and run this script');
    
    // Uncomment this line after updating login credentials:
    // await testLogin();
    
    if (!testData.authToken || testData.authToken === 'your_auth_token_here') {
        console.log('âŒ No valid auth token. Please login first.');
        console.log('ğŸ’¡ Update testData.authToken with a valid token or use testLogin()');
        return;
    }

    // Run all tests
    await testSaveAiRecipe();
    await testGetUserAiRecipes();
    await testUpdateAiRecipe();
    await testDeleteAiRecipe();
    
    console.log('\nâœ… All tests completed!');
}

// Helper function to test admin endpoints
async function testAdminEndpoints() {
    console.log('\nğŸ§ª Testing Admin Endpoints (Browser-based)...');
    console.log('ğŸŒ Visit these URLs in your browser after logging into admin panel:');
    console.log(`ğŸ“Š AI Recipes List: ${baseURL}/ai-recipes`);
    console.log(`ğŸ“ˆ AI Recipe Stats: ${baseURL}/ai-recipe-stats`);
    console.log(`ğŸ” AI Recipe Detail: ${baseURL}/ai-recipe-detail?id=RECIPE_ID_HERE`);
    console.log(`ğŸ—‘ï¸ Delete AI Recipe: ${baseURL}/delete-ai-recipe?id=RECIPE_ID_HERE`);
}

// Export for use in other files
module.exports = {
    runAllTests,
    testSaveAiRecipe,
    testGetUserAiRecipes,
    testUpdateAiRecipe,
    testDeleteAiRecipe,
    testLogin,
    testAdminEndpoints
};

// Run tests if this file is executed directly
if (require.main === module) {
    runAllTests();
    testAdminEndpoints();
}
